!function(c,d,l,r){c(function(){var e=c(".wc-auction-class-rows"),t=c(".wc-auction-class-save"),i=l.template("wc-auction-class-row"),s=l.template("wc-auction-class-row-blank"),n=Backbone.Model.extend({changes:{},logChanges:function(e){var i=this.changes||{};_.each(e,function(e,t){i[t]=_.extend(i[t]||{term_id:t},e)}),this.changes=i,this.trigger("change:classes")},save:function(){_.size(this.changes)?c.post(r+(0<r.indexOf("?")?"&":"?")+"action=auction_software_save_wc_classes",{wc_auction_classes_nonce:d.wc_auction_classes_nonce,changes:this.changes},this.onSaveResponse,"json"):a.trigger("saved:classes")},discardChanges:function(e){delete(this.changes||{})[e],0===_.size(this.changes)&&o.clearUnloadConfirmation()},onSaveResponse:function(e,t){"success"===t&&(e.success?(a.set("classes",e.data.auction_classes),a.trigger("change:classes"),a.changes={},a.trigger("saved:classes")):e.data?window.alert(e.data):window.alert(d.strings.save_failed)),o.unblock()}}),i=Backbone.View.extend({rowTemplate:i,initialize:function(){this.listenTo(this.model,"change:classes",this.setUnloadConfirmation),this.listenTo(this.model,"saved:classes",this.clearUnloadConfirmation),this.listenTo(this.model,"saved:classes",this.render),e.on("change",{view:this},this.updateModelOnChange),c(window).on("beforeunload",{view:this},this.unloadConfirmation),t.on("click",{view:this},this.onSubmit),c(document.body).on("click",".wc-auction-class-add",{view:this},this.onAddNewRow),c(document.body).on("click",".wc-auction-class-save-changes",{view:this},this.onSubmit)},block:function(){c(this.el).block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblock:function(){c(this.el).unblock()},render:function(){var i,e=_.indexBy(this.model.get("classes"),"term_id"),n=this;this.$el.empty(),this.unblock(),_.size(e)?(e=_.sortBy(e,(i="name",function(e){var t=parseInt(e[i],10);return isNaN(t)?e[i]:t})),c.each(e,function(e,t){n.renderRow(t)})):n.$el.append(s)},renderRow:function(e){var t=this;t.$el.append(t.rowTemplate(e)),t.initRow(e)},initRow:function(t){var e=this.$el.find('tr[data-id="'+t.term_id+'"]');e.find("select").each(function(){var e=c(this).data("attribute");c(this).find('option[value="'+t[e]+'"]').prop("selected",!0)}),e.find(".view").show(),e.find(".edit").hide(),e.find(".wc-auction-class-edit").on("click",{view:this},this.onEditRow),e.find(".wc-auction-class-delete").on("click",{view:this},this.onDeleteRow),e.find(".editing .wc-auction-class-edit").trigger("click"),e.find(".wc-auction-class-cancel-edit").on("click",{view:this},this.onCancelEditRow),!0===t.editing&&(e.addClass("editing"),e.find(".wc-auction-class-edit").trigger("click"))},onSubmit:function(e){e.data.view.block(),e.data.view.model.save(),e.preventDefault()},onAddNewRow:function(e){e.preventDefault();var e=e.data.view,t=e.model,i=_.indexBy(t.get("classes"),"term_id"),n={},i=_.size(i),i=_.extend({},d.default_auction_class,{term_id:"new-"+i+"-"+Date.now(),editing:!0,newRow:!0});n[i.term_id]=i,t.logChanges(n),e.renderRow(i),c(".wc-auction-classes-blank-state").remove()},onEditRow:function(e){e.preventDefault(),c(this).closest("tr").addClass("editing"),c(this).closest("tr").find(".view").hide(),c(this).closest("tr").find(".edit").show(),e.data.view.model.trigger("change:classes")},onDeleteRow:function(e){var t=e.data.view,i=t.model,n=_.indexBy(i.get("classes"),"term_id"),s={},a=c(this).closest("tr").data("id");e.preventDefault(),n[a]&&(delete n[a],s[a]=_.extend(s[a]||{},{deleted:"deleted"}),i.set("classes",n),i.logChanges(s)),t.render()},onCancelEditRow:function(e){var t=e.data.view,i=t.model,n=c(this).closest("tr"),s=c(this).closest("tr").data("id"),a=_.indexBy(i.get("classes"),"term_id");e.preventDefault(),i.discardChanges(s),a[s]&&(a[s].editing=!1,n.after(t.rowTemplate(a[s])),t.initRow(a[s])),n.remove()},setUnloadConfirmation:function(){this.needsUnloadConfirm=!0,t.removeAttr("disabled")},clearUnloadConfirmation:function(){this.needsUnloadConfirm=!1,t.attr("disabled","disabled")},unloadConfirmation:function(e){if(e.data.view.needsUnloadConfirm)return e.returnValue=d.strings.unload_confirmation_msg,window.event.returnValue=d.strings.unload_confirmation_msg,d.strings.unload_confirmation_msg},updateModelOnChange:function(e){var t=e.data.view.model,e=c(e.target),i=e.closest("tr").data("id"),n=e.data("attribute"),e=e.val(),s=_.indexBy(t.get("classes"),"term_id"),a={};s[i]&&s[i][n]===e||(a[i]={},a[i][n]=e),t.logChanges(a)}}),a=new n({classes:d.classes}),o=new i({model:a,el:e});o.render()})}(jQuery,auctionClassesLocalizeScript,wp,ajaxurl);